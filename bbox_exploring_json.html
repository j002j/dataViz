<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Bounding Box Explorer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <style>
        /* Use Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling of the whole page */
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }
        #cityListContainer::-webkit-scrollbar {
            width: 6px;
        }
        #cityListContainer::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* cool-gray-300 */
            border-radius: 3px;
        }
        #cityListContainer::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* cool-gray-100 */
        }
    </style>
</head>
<body class="h-screen bg-gray-100 flex flex-col lg:flex-row">

    <div class="w-full lg:w-1/3 xl:w-1/4 h-1/2 lg:h-full flex flex-col bg-white shadow-lg z-10 p-4 lg:p-6 overflow-hidden">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Bounding Box Explorer</h1>
        
        <div class="flex space-x-4 mb-4">
            <div class="flex items-center space-x-1.5">
                <div class="w-4 h-4 rounded-sm border-2 border-blue-500 bg-blue-500 bg-opacity-10"></div>
                <span class="text-sm text-gray-600">Pending</span>
            </div>
            <div class="flex items-center space-x-1.5">
                <div class="w-4 h-4 rounded-sm border-2 border-green-600 bg-green-600 bg-opacity-10"></div>
                <span class="text-sm text-gray-600">Scanned</span>
            </div>
        </div>

        <h3 class="text-lg font-semibold text-gray-700 mb-2 flex-shrink-0">Cities from Database</h3>
        <div id="cityListContainer" class="flex-grow overflow-y-auto bg-gray-50 border rounded-md divide-y divide-gray-200">
            <p id="cityListPlaceholder" class="p-4 text-gray-500 text-center">Loading cities from server...</p>
        </div>
    </div>

    <div class="w-full lg:w-2/3 xl:w-3/4 h-1/2 lg:h-full">
        <div id="map"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize the Map
            const map = L.map('map').setView([20, 0], 2); // Centered on the world
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Layer group to hold all our rectangles
            let rectangleLayers = L.layerGroup().addTo(map);

            // Get DOM elements
            const cityListEl = document.getElementById('cityListContainer');
            const cityListPlaceholder = document.getElementById('cityListPlaceholder');

            // 2. Function to plot boxes on the map
            function plotBoxes(cityData) {
                rectangleLayers.clearLayers();
                cityListEl.innerHTML = '';
                
                const allBounds = [];

                if (!cityData || cityData.length === 0) {
                    cityListEl.appendChild(cityListPlaceholder);
                    cityListPlaceholder.innerText = "No cities found in database.";
                    return;
                }

                cityData.forEach(city => {
                    if (city.bbox && city.bbox.south !== undefined) {
                        const bounds = [
                            [city.bbox.south, city.bbox.west],
                            [city.bbox.north, city.bbox.east]
                        ];
                        
                        allBounds.push(bounds);

                        // --- MODIFIED: Color based on 'scanned' status ---
                        const color = city.scanned ? "#16a34a" : "#3b82f6"; // green-600 or blue-500
                        const status = city.scanned ? "✅ Scanned" : "⌛ Pending";

                        const rect = L.rectangle(bounds, { 
                            color: color, 
                            weight: 2, 
                            fillOpacity: 0.1 
                        });
                        
                        rect.bindPopup(`<b>${city.name}</b><br><small>${status}</small>`);
                        rectangleLayers.addLayer(rect);

                        // Create list item in the sidebar
                        const item = document.createElement('div');
                        item.className = 'p-3 hover:bg-gray-200 rounded-md cursor-pointer transition-colors duration-100 ease-in-out flex items-center space-x-2';
                        // --- MODIFIED: Show simple name and status icon ---
                        item.innerHTML = `<span>${city.scanned ? '✅' : '⌛'}</span> <span>${city.name.split(',')[0]}</span>`;
                        item.title = city.name;
                        
                        item.onclick = () => {
                            map.fitBounds(bounds);
                            rect.openPopup();
                        };
                        
                        cityListEl.appendChild(item);
                    }
                });

                if (allBounds.length > 0) {
                    map.fitBounds(allBounds, { padding: [50, 50] });
                }
            }

            // 3. --- NEW: Function to load data from our server ---
            async function loadCitiesFromServer() {
                try {
                    const response = await fetch('/api/cities'); // Fetch from our new endpoint
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const cities = await response.json();
                    plotBoxes(cities); // Pass data to existing plot function
                } catch (e) {
                    console.error("Failed to load cities:", e);
                    cityListPlaceholder.innerText = "Failed to load cities from server. Is it running?";
                }
            }

            // 4. --- MODIFIED: Call the new load function ---
            loadCitiesFromServer();
        });
    </script>
</body>
</html>